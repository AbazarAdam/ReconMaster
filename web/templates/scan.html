{% extends "base.html" %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card p-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div>
                    <h2 class="mb-0 fw-bold">SCANNING: {{ scan.target }}</h2>
                    <small class="text-muted">ID: {{ scan_id }}</small>
                </div>
                <div>
                    <span id="scanStatus" class="badge bg-warning fs-6">{{ scan.status|upper }}</span>
                </div>
            </div>

            <div class="mt-4">
                <h5 class="card-title"><i class="fas fa-terminal"></i> LIVE CONSOLE</h5>
                <div id="logConsole" class="log-console mt-2">
                    <!-- Logs will appear here -->
                </div>
            </div>

            <div class="mt-4 d-flex justify-content-end">
                <a id="btnViewResults" href="/results/{{ scan.target }}" class="btn btn-primary disabled">
                    <i class="fas fa-file-alt"></i> VIEW FULL REPORT
                </a>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-12">
        <div class="card p-4">
            <h5 class="card-title"><i class="fas fa-layer-group"></i> MODULE PROGRESS</h5>
            <div class="progress my-3">
                <div id="scanProgress" class="progress-bar" role="progressbar" style="width: 0%"></div>
            </div>
            <div class="row g-2" id="moduleGrid">
                <div class="col-12 text-center text-muted">Awaiting module initialization...</div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const SCAN_ID = "{{ scan_id }}";
    const TARGET = "{{ scan.target }}";

    // Inline WebSocket script for debugging
    console.log('=== INLINE WEBSOCKET SCRIPT LOADED ===');
    console.log('SCAN_ID:', SCAN_ID);

    document.addEventListener('DOMContentLoaded', function () {
        console.log('DOM loaded, initializing WebSocket...');

        const logConsole = document.getElementById('logConsole');
        const scanStatus = document.getElementById('scanStatus');
        const btnResults = document.getElementById('btnViewResults');
        const scanProgress = document.getElementById('scanProgress');

        if (!logConsole) {
            console.error('ERROR: logConsole element not found!');
            alert('ERROR: logConsole element not found! Check HTML.');
            return;
        }

        console.log('Elements found:', { logConsole, scanStatus, btnResults, scanProgress });

        let logCount = 0;
        const MAX_LOGS = 1000;

        function addLog(message, className = '') {
            const div = document.createElement('div');
            if (className) div.className = className;
            div.textContent = message;
            logConsole.appendChild(div);
            logCount++;

            // Cap logs to prevent lag
            if (logCount > MAX_LOGS) {
                logConsole.removeChild(logConsole.firstChild);
                logCount--;
            }

            // Auto-scroll logic (only if user is near bottom)
            const isNearBottom = logConsole.scrollHeight - logConsole.clientHeight - logConsole.scrollTop < 50;
            if (isNearBottom) {
                logConsole.scrollTop = logConsole.scrollHeight;
            }
        }

        function updateProgress(percent) {
            if (scanProgress) {
                scanProgress.style.width = percent + '%';
            }
        }

        const wsUrl = `ws://${window.location.host}/ws/${SCAN_ID}`;
        const ws = new WebSocket(wsUrl);

        ws.onopen = function () {
            addLog('[System] Connected to live updates!', 'text-success fw-bold');
        };

        ws.onmessage = function (event) {
            try {
                const data = JSON.parse(event.data);

                if (data.type === 'log') {
                    addLog(`[${new Date().toLocaleTimeString()}] ${data.message}`);
                } else if (data.type === 'status') {
                    addLog(`[STATUS] ${data.status.toUpperCase()}`, 'text-warning fw-bold');
                    if (scanStatus) {
                        scanStatus.textContent = data.status.toUpperCase();
                        scanStatus.className = `badge bg-${data.status === 'completed' ? 'success' : (data.status === 'failed' ? 'danger' : 'warning')} fs-6`;
                    }
                    if (data.status === 'completed') {
                        updateProgress(100);
                        if (btnResults) btnResults.classList.remove('disabled');
                        addLog('[System] Scan finished successfully!', 'text-success fw-bold');

                        // Clear any remaining spinners
                        const spinners = document.querySelectorAll('.spinner-border');
                        spinners.forEach(s => {
                            const parent = s.parentElement;
                            s.remove();
                            const icon = document.createElement('i');
                            icon.className = 'fas fa-check-circle text-success mt-1';
                            parent.appendChild(icon);
                        });
                    } else if (data.status === 'failed') {
                        addLog('[System] Scan failed.', 'text-danger fw-bold');
                    }
                } else if (data.type === 'phase') {
                    addLog(`>>> Phase: ${data.phase}`, 'text-info fw-bold');

                    // Progress heuristic
                    const phaseNum = parseInt(data.phase.match(/\d+/));
                    if (!isNaN(phaseNum)) {
                        updateProgress(phaseNum * 20 - 10);
                    }

                    // Update module grid
                    const moduleGrid = document.getElementById('moduleGrid');
                    if (moduleGrid && data.modules) {
                        moduleGrid.innerHTML = '';
                        data.modules.forEach(moduleName => {
                            const col = document.createElement('div');
                            col.className = 'col-md-2 mb-2';
                            col.id = `mod-${moduleName.replace(/[^a-z0-9]/gi, '_')}`;
                            col.innerHTML = `
                                <div class="card bg-dark p-2 text-center">
                                    <small class="text-muted mb-1">${moduleName}</small>
                                    <div class="spinner-border spinner-border-sm text-secondary mx-auto" role="status"></div>
                                </div>
                            `;
                            moduleGrid.appendChild(col);
                        });
                    }
                } else if (data.type === 'module_end') {
                    const modId = `mod-${data.module.replace(/[^a-z0-9]/gi, '_')}`;
                    const modEl = document.getElementById(modId);
                    if (modEl) {
                        const spinner = modEl.querySelector('.spinner-border');
                        if (spinner) {
                            spinner.remove();
                            const icon = document.createElement('i');
                            if (data.status === 'completed') {
                                icon.className = 'fas fa-check-circle text-success mt-1';
                            } else {
                                icon.className = 'fas fa-times-circle text-danger mt-1';
                                icon.title = data.error || 'Failed';
                            }
                            modEl.querySelector('.card').appendChild(icon);
                        }
                    }
                } else if (data.type === 'error') {
                    addLog(`[ERROR] ${data.message}`, 'text-danger');
                }
            } catch (e) {
                console.error('WS Error:', e);
            }
        };

        ws.onerror = function (error) {
            console.error('‚ùå WebSocket ERROR:', error);
            addLog('[ERROR] WebSocket connection error', 'text-danger fw-bold');
        };

        ws.onclose = function (event) {
            console.log('üîå WebSocket CLOSED:', event.code, event.reason);
            addLog('[System] Connection closed', 'text-muted');
        };

        window.debugWS = ws;
        console.log('WebSocket available as window.debugWS');
    });
</script>
{% endblock %}