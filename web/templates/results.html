{% extends "base.html" %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-12">
        <h2 class="text-neon-cyan"><i class="fas fa-poll"></i> Scan Results: {{ target }}</h2>
        <a href="/" class="btn btn-sm btn-outline-secondary mt-2"><i class="fas fa-arrow-left"></i> Back to
            Dashboard</a>
    </div>
</div>

<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <ul class="nav nav-tabs card-header-tabs" id="resultsTabs" role="tablist">
                    <li class="nav-item">
                        <button class="nav-link active" id="summary-tab" data-bs-toggle="tab" data-bs-target="#summary"
                            type="button" role="tab">Summary</button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" id="subdomains-tab" data-bs-toggle="tab" data-bs-target="#subdomains"
                            type="button" role="tab">Subdomains</button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" id="ports-tab" data-bs-toggle="tab" data-bs-target="#ports"
                            type="button" role="tab">Open Ports</button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" id="http-tab" data-bs-toggle="tab" data-bs-target="#http" type="button"
                            role="tab">HTTP Info</button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" id="screenshots-tab" data-bs-toggle="tab" data-bs-target="#screenshots"
                            type="button" role="tab">Screenshots</button>
                    </li>
                </ul>
            </div>
            <div class="card-body">
                <div class="tab-content" id="resultsTabContent">
                    <!-- Summary Tab -->
                    <div class="tab-pane fade show active" id="summary" role="tabpanel">
                        <h4 class="mb-3">Executive Summary</h4>
                        <div id="summaryStats" class="row">
                            <div class="col-md-3 mb-3">
                                <div class="card bg-dark border-success p-3 text-center">
                                    <h3 class="text-success" id="countSubdomains">0</h3>
                                    <small>Subdomains</small>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <div class="card bg-dark border-warning p-3 text-center">
                                    <h3 class="text-warning" id="countPorts">0</h3>
                                    <small>Open Ports</small>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <div class="card bg-dark border-info p-3 text-center">
                                    <h3 class="text-info" id="countHttp">0</h3>
                                    <small>Web Services</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Subdomains Tab -->
                    <div class="tab-pane fade" id="subdomains" role="tabpanel">
                        <input type="text" class="form-control mb-3" id="searchSubdomains"
                            placeholder="Filter subdomains...">
                        <div class="table-responsive">
                            <table class="table table-dark table-hover table-sm" id="tableSubdomains">
                                <thead>
                                    <tr>
                                        <th>Subdomain</th>
                                        <th>Source</th>
                                        <th>IP Address</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Ports Tab -->
                    <div class="tab-pane fade" id="ports" role="tabpanel">
                        <div class="table-responsive">
                            <table class="table table-dark table-hover table-sm" id="tablePorts">
                                <thead>
                                    <tr>
                                        <th>Host</th>
                                        <th>Port</th>
                                        <th>Service</th>
                                        <th>State</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- HTTP Tab -->
                    <div class="tab-pane fade" id="http" role="tabpanel">
                        <div class="table-responsive">
                            <table class="table table-dark table-hover table-sm" id="tableHttp">
                                <thead>
                                    <tr>
                                        <th>URL</th>
                                        <th>Status</th>
                                        <th>Title</th>
                                        <th>Tech Stack</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Screenshots Tab -->
                    <div class="tab-pane fade" id="screenshots" role="tabpanel">
                        <div class="row" id="galleryScreenshots">
                            <!-- Thumbnails -->
                        </div>
                    </div>


                </div>
            </div>
        </div>
    </div>
</div>

<!-- Lightbox Modal -->
<div class="modal fade" id="lightboxModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content bg-dark border-secondary">
            <div class="modal-header border-secondary">
                <h5 class="modal-title text-light" id="lightboxTitle">Screenshot</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <div class="modal-body p-0 text-center">
                <img src="" id="lightboxImage" class="img-fluid" alt="Screenshot">
            </div>
        </div>
    </div>
</div>

</div>
</div>

{% endblock %}

{% block scripts %}
<script>
    // Inject backend variables
    window.TARGET = "{{ target }}";
    window.SCAN_ID = "{{ scan_id }}";

    // Global data stores for lazy loading
    let ALL_DATA = { subdomains: [], ports: [], http: [], screenshots: [] };
    let DISPLAY_COUNTS = { subdomains: 200, ports: 200, http: 200, screenshots: 50 };

    document.addEventListener("DOMContentLoaded", async function () {
        console.log('DOM loaded, fetching results...');

        if (!TARGET) {
            console.error('No TARGET defined!');
            return;
        }

        try {
            const scanId = window.SCAN_ID;
            let url;
            if (scanId && scanId !== 'None' && scanId !== '') {
                console.log(`[DEBUG] Fetching results for scan ID: ${scanId}`);
                url = `/api/scans/${scanId}/results`;
            } else {
                console.log(`[DEBUG] Fetching all results for target: ${TARGET}`);
                url = `/api/targets/${TARGET}/results`;
            }
            const response = await fetch(url);
            if (!response.ok) throw new Error(`HTTP ${response.status}`);

            const results = await response.json();
            console.log('Results received:', results.length);

            // Clear previous data
            ALL_DATA = { subdomains: [], ports: [], http: [], screenshots: [] };

            // Process results in small chunks to keep UI responsive
            const chunkSize = 500;
            for (let i = 0; i < results.length; i += chunkSize) {
                const chunk = results.slice(i, i + chunkSize);
                chunk.forEach(res => {
                    const type = res.type;
                    const item = res.data;
                    const items = Array.isArray(item) ? item : [item];

                    items.forEach(entry => {
                        const enriched = { ...entry, source: res.module };
                        if (type === 'subdomain') ALL_DATA.subdomains.push(enriched);
                        else if (type === 'portscan' || type === 'port') ALL_DATA.ports.push(enriched);
                        else if (type === 'http') ALL_DATA.http.push(enriched);
                        else if (type === 'screenshot') ALL_DATA.screenshots.push(enriched);
                    });
                });
                // Allow UI to breathe
                if (i % 2000 === 0) await new Promise(r => setTimeout(r, 0));
            }

            // Update summary
            document.getElementById("countSubdomains").textContent = ALL_DATA.subdomains.length;
            document.getElementById("countPorts").textContent = ALL_DATA.ports.length;
            document.getElementById("countHttp").textContent = ALL_DATA.http.length;

            // Initial render
            renderAll();

            console.log('✅ Initial render complete');

        } catch (e) {
            console.error('❌ Error:', e);
            document.getElementById("summaryStats").innerHTML =
                `<div class="alert alert-danger w-100">Failed to load results: ${e.message}</div>`;
        }

        // Search filter (optimized for large lists)
        let searchTimeout;
        document.getElementById("searchSubdomains").addEventListener("input", function () {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                const filter = this.value.toLowerCase();
                if (!filter) {
                    renderSubdomains();
                    return;
                }
                const filtered = ALL_DATA.subdomains.filter(s =>
                    (s.subdomain || '').toLowerCase().includes(filter) ||
                    (s.source || '').toLowerCase().includes(filter)
                );
                renderSubdomains(filtered, true);
            }, 300);
        });
    });

    function renderAll() {
        renderSubdomains();
        renderPorts();
        renderHttp();
        renderScreenshots();
    }

    function renderSubdomains(items = ALL_DATA.subdomains, isFiltered = false) {
        const tbody = document.querySelector("#tableSubdomains tbody");
        const count = isFiltered ? items.length : DISPLAY_COUNTS.subdomains;
        const displayItems = items.slice(0, count);

        const html = displayItems.map(item => `
            <tr>
                <td>${item.subdomain || 'N/A'}</td>
                <td><span class="badge bg-info">${item.source || 'unknown'}</span></td>
            </tr>
        `).join('');

        tbody.innerHTML = html;

        // Add "Load More" button if needed
        if (!isFiltered && items.length > count) {
            const row = document.createElement('tr');
            row.innerHTML = `<td colspan="2" class="text-center p-3">
                <button class="btn btn-sm btn-outline-info" onclick="loadMore('subdomains')">
                    Load More (${items.length - count} remaining)
                </button>
            </td>`;
            tbody.appendChild(row);
        }
    }

    function renderPorts() {
        const tbody = document.querySelector("#tablePorts tbody");
        if (ALL_DATA.ports.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">No open ports found</td></tr>';
            return;
        }

        const html = ALL_DATA.ports.slice(0, DISPLAY_COUNTS.ports).map(item => `
            <tr>
                <td>${item.ip || item.host || 'N/A'}</td>
                <td><span class="badge bg-danger">${item.port}</span></td>
                <td>${item.service || 'unknown'}</td>
                <td>${item.state || 'open'}</td>
            </tr>
        `).join('');
        tbody.innerHTML = html;

        if (ALL_DATA.ports.length > DISPLAY_COUNTS.ports) {
            const row = document.createElement('tr');
            row.innerHTML = `<td colspan="4" class="text-center p-3">
                <button class="btn btn-sm btn-outline-info" onclick="loadMore('ports')">Load More</button>
            </td>`;
            tbody.appendChild(row);
        }
    }

    function renderHttp() {
        const tbody = document.querySelector("#tableHttp tbody");
        if (ALL_DATA.http.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">No HTTP services found</td></tr>';
            return;
        }

        const html = ALL_DATA.http.slice(0, DISPLAY_COUNTS.http).map(item => `
            <tr>
                <td><a href="${item.url}" target="_blank">${item.url}</a></td>
                <td><span class="badge bg-${item.status >= 200 && item.status < 300 ? 'success' : (item.status >= 400 ? 'danger' : 'warning')}">${item.status || 'N/A'}</span></td>
                <td>${item.title || 'N/A'}</td>
                <td><small class="text-muted">${item.server || 'Unknown'}</small></td>
            </tr>
        `).join('');
        tbody.innerHTML = html;
    }

    function renderScreenshots() {
        const container = document.getElementById("galleryScreenshots");
        if (!container) return;

        if (ALL_DATA.screenshots.length === 0) {
            container.innerHTML = '<div class="col-12 text-center text-muted p-5">No screenshots available</div>';
            return;
        }

        const html = ALL_DATA.screenshots.slice(0, DISPLAY_COUNTS.screenshots).map(item => {
            let rawPath = item.screenshot_path || item.path || '';
            let path = rawPath.replace(/\\/g, '/');
            if (path && !path.startsWith('/')) path = '/' + path;

            return `
                <div class="col-md-4 mb-3">
                    <div class="card bg-dark border-secondary">
                        <div class="screenshot-wrapper cursor-pointer" onclick="openLightbox('${path}', '${item.url}')">
                           <img src="${path}" class="card-img-top" alt="Screenshot" onerror="this.src='/static/img/no-image.png'; this.onerror=null;">
                        </div>
                        <div class="card-body py-2">
                            <p class="card-text mb-0"><small class="text-info">${item.url || 'N/A'}</small></p>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
        container.innerHTML = html;
    }

    function renderVulns() {
        const tbody = document.querySelector("#tableVulns tbody");
        if (ALL_DATA.vulns.length === 0) {
            tbody.innerHTML = '<tr><td colspan="3" class="text-center text-muted">No vulnerabilities found</td></tr>';
            return;
        }

        const html = ALL_DATA.vulns.slice(0, DISPLAY_COUNTS.vulns).map(item => {
            let finding = '';
            if (item.type === 'cloud_bucket') {
                finding = `Bucket: <strong>${item.bucket}</strong> (${item.provider}) - Status: <span class="badge ${item.status === 'public' ? 'bg-danger' : 'bg-success'}">${item.status}</span>`;
            } else if (item.type === 'github') {
                finding = `Repo: <a href="${item.url}" target="_blank">${item.repo}</a> - ${item.description || 'No description'}`;
            } else if (item.type === 'shodan') {
                finding = `Shodan data: ${item.data || 'Enriched data available'}`;
            } else {
                finding = item.description || item.bucket || item.repo || JSON.stringify(item);
            }

            return `
                <tr>
                    <td><span class="badge bg-warning">${item.type || 'unknown'}</span></td>
                    <td>${finding}</td>
                    <td><span class="badge bg-secondary">${item.source || 'unknown'}</span></td>
                </tr>
            `;
        }).join('');
        tbody.innerHTML = html;
    }

    window.loadMore = function (category) {
        if (category === 'subdomains') DISPLAY_COUNTS.subdomains += 500;
        if (category === 'ports') DISPLAY_COUNTS.ports += 200;
        renderAll();
    };

    window.openLightbox = function (path, url) {
        const modal = new bootstrap.Modal(document.getElementById('lightboxModal'));
        document.getElementById('lightboxImage').src = path;
        document.getElementById('lightboxTitle').textContent = url || 'Screenshot';
        modal.show();
    };
</script>
{% endblock %}